<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <!--skip-->
        <title>Meeting</title>

        <!--hide-->
        <link rel="stylesheet" type="text/css" href="css/landing.css" />
        <link href="css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/font-awesome.min.css" rel="stylesheet" />
        <link href="css/default.css" rel="stylesheet" type="text/css" />
        <link href="css/font-awesome.min.css" rel="stylesheet" />

        <!-- Prettify Code -->
        <script type="text/javascript" src="js/prettify/prettify.js"></script>
        <link rel="stylesheet" type="text/css" href="js/prettify/prettify.css" />
        <script type="text/javascript" src="js/prettify/loadAndFilter.js"></script>
        <!-- <script type="text/javascript" src="js/prettify/jquery.min.js"></script> -->
        <!--show-->
        <!-- Assumes global locations for socket.io.js and easyrtc.js -->
        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery.min.js"></script>

        <!-- <script type="text/javascript" src="../easyrtc/easyrtc.js"></script>-->
        <script type="text/javascript" src="js/demo_instant_messaging.js"></script>
        <script type="text/javascript" src="js/demo_multiparty.js"></script> 

        <script src="/dist/RTCMultiConnection.min.js"></script>
        <script src="/node_modules/webrtc-adapter/out/adapter.js"></script>

        <link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
        <script src="/dev/getHTMLMediaElement.js"></script>

        
        <script src="js/bootstrap.min.js"></script>
        
        
        <!--hide-->
        <!-- Styles used within the demo -->
        <style type="text/css">
            #stuffToSend {width:300px;}
            #sendMessageArea{
                float:left;
                width:100%;
                /* padding-right:20px; */
            }
            #sendMessageText{
                width:100%;
                height: 80px;
                margin-bottom: 10px;
            }
            #conversation {
                height:350px;
                border:solid 1px gray;
                overflow-y:scroll;
            }
            /* #left {
                position: absolute;
                left: 16px;
                top: 102px;
                width: 186px;
                height: 100%;
                background: gray;
            } */
            /* #main {
                margin-left: 200px;
            } */
            #share {
                float: right;
            }
        </style>
        <!--show-->
    </head>
    <body>
        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <!-- <button type="button" class="navbar-toggle show pull-left" data-target="sidebar">
                        <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                    </button> -->
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                            aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/"><img class="fa fa-user fa-fw" src="./images/br_safari.png" style="display: inline;margin-right: 10px;"></img>语音会议系统</a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav" style="margin-left: 20px;">
                        <li><a href="/">讲课模式</a></li>
                        <li><a href="/demos/demo_desktop_share.html">桌面共享</a></li>
                        <li onclick="quitMeeting()"><a class="menu_link">退出会议</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                               aria-expanded="false" id="userInfo"><i class="fa fa-user fa-fw"></i>&nbsp;小王&nbsp;<span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="login.html"><i class="fa fa-sign-out fa-fw"></i>&nbsp;退出登录</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!--hide-->
        <div class="container-fluid all">
            <div class="sidebar">
                <div class="sidebar-scroll">
                    <ul class="nav">
                        <li class="active">参会人员</li>
                        <li id="mine"></li>
                        <li id="others"></li>
                        <!-- <div id="quickJoinBlock"></div>
                        <div >
                            <input id="roomToAdd" type="text" size="20" placeholder="请输入房间号"/>
                            <button onclick="addRoom(null, null, true);">加入会议</button>
                        </div> -->
                    </ul>
                </div>
            </div>
            <div class="maincontent row">
                <!--我是主要内容 start-->                   
                <ul class="breadcrumb" id="receiveMessageArea">
                    <li class="active" >聊天窗口</li>                                           
                </ul>
                <div id="main">
                    <!-- <h2>The Demo</h2> -->
                    <!--show-->
                    <div  id="conversation"></div>  
                    <div id="sendMessageArea">
                        <div id="iam">Not connected yet</div>
                        <textarea id="sendMessageText" placeholder="在这里输入信息"></textarea>
                        <div id="otherClients"></div>
                        Rooms:
                        <div id="rooms"></div>
                        <button class="btn btn-primary" id="sendMessageButton" onclick="sendMessage()">发送</button>
                    </div>
                    <hr />    
                </div>
                <!--我是主要内容 end-->
            </div>
        </div>
    </body>
    <script type="application/javascript">


        var participantsRTCIdMap;
        window.onload = function() {
            var url = window.location.href;
            var roomId = url.substring(url.lastIndexOf("=") + 1);
            // connection.openOrJoin(roomId, function(isRoomExist, roomid) {
            //     if (!isRoomExist) {
            //     showRoomURL(roomid);
            //     }
            // });
            connection.openOrJoin(roomId,messageLoginSuccess);
        }

        function messageLoginSuccess() {
            var name = document.getElementById('userInfo').text;
            document.getElementById("mine").innerHTML = name + " (你的账号)";
            addUserRTCid();
        }

        document.getElementById('sendMessageText').onkeyup = function(e) {
                if (e.keyCode != 13) return;

                // removing trailing/leading whitespace
                this.value = this.value.replace(/^\s+|\s+$/g, '');
                if (!this.value.length) return;

                connection.send(this.value);
                appendDIV(this.value);
                this.value = '';
        };

        function sendMessage() {
            var textarea = document.getElementById('sendMessageText')
            textarea.value = textarea.value.replace(/^\s+|\s+$/g, '');
                if (!textarea.value.length) return;

                connection.send(textarea.value);
                appendDIV(textarea.value);
                textarea.value = '';

        }
        // var chatContainer = document.querySelector('.active');
        var chatContainer = document.getElementById('conversation');

        function appendDIV(event) {
            var li = document.createElement('li');
            var name = participantsRTCIdMap[event.userid] || 'me';
            var myDate = new Date().toLocaleString();
            li.innerHTML = name+'::::'+myDate+'<br>'+(event.data || event);
            chatContainer.append(li);
            li.tabIndex = 0;
            li.focus();

            document.getElementById('sendMessageText').focus();
        }

        function renderParticipants () {
            var participants = connection.peers.getAllParticipants();
            var others = document.getElementById('others');
            others.innerHTML = '';
            // 左侧参会人人员
            for(var i = 0; i < participants.length; i++) {
                var div = document.createElement('div');
                var labelLeft = document.createTextNode(participantsRTCIdMap[participants[i]]);
                div.appendChild(labelLeft);
                others.appendChild(div);
            }
        }

        function addUserRTCid() {
            var name = document.getElementById('userInfo').text;
            var params = {
                meetingId: roomId,
                rtcId: connection.userid,
                userName: name
            };
            $.ajax({
                //请求方式
                type : "POST",
                //请求的媒体类型
                contentType: "application/json",
                //请求地址
                url : "http://117.78.9.153:24750/teamtalk/v1/meeting/addMeetingUser",
                //数据，json字符串

                data :JSON.stringify(params),
                xhrFields:{
                    withCredentials:true
                },

                //请求成功
                success : function(result) {
                    console.log(result);
                },
                //请求失败，包含具体的错误信息
                error : function(e){
                    console.log(e.message);
                }
            });
        }

        function deleteUserRTCid() {
            var params = {
                meetingId: roomId,
                rtcId: connection.userid
            };
            $.ajax({
                //请求方式
                type : "POST",
                //请求的媒体类型
                contentType: "application/json",
                //请求地址
                url : "http://117.78.9.153:24750/teamtalk/v1/meeting/deleteMeetingUser",
                //数据，json字符串

                data :JSON.stringify(params),
                xhrFields:{
                    withCredentials:true
                },

                //请求成功
                success : function(result) {
                    console.log(result)
                },
                //请求失败，包含具体的错误信息
                error : function(e){
                    console.log(e.message);
                }
            });
        }

        function getParticipantList() {
            $.ajax({
                //请求方式
                type : "GET",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded;charset=UTF-8",
                //请求地址
                url : "http://117.78.9.153:24750/teamtalk/v1/meeting/getUserListByMeetingId",
                //数据，json字符串

                data :{
                    "meetingId":roomId
                },
                xhrFields:{
                    withCredentials:true
                },

                //请求成功
                success : function(result) {

                    if(result.code == 200){
                        participantsRTCIdMap = result.data
                        renderParticipants();
                    }else{
                        console.log(e.message);
                    }
                },
                //请求失败，包含具体的错误信息
                error : function(e){
                    console.log(e.message);
                }
            });
        }

        function quitMeeting() {
            deleteUserRTCid();
            var clientList = connection.peers.getAllParticipants();
            if (clientList.length < 1) {
                var params = {"mId":roomId}
                $.ajax({
                    //请求方式
                    type : "POST",
                    //请求的媒体类型
                    contentType: "application/json",
                    //请求地址
                    url : "http://117.78.9.153:24750/teamtalk/v1/meeting/endMeeting",
                    //数据，json字符串

                    data :JSON.stringify(params),
                    xhrFields:{
                        withCredentials:true
                    },

                    //请求成功
                    success : function(result) {
                        window.location.href = '/demos/meeting_index.html';
                    },
                    //请求失败，包含具体的错误信息
                    error : function(e){
                        console.log(e.message);
                        window.location.herf = './demos/meeting_index.html';
                    }
                });
                window.location.herf = './demos/meeting_index.html';
            } else {
                window.location.href = '/demos/meeting_index.html';
            }
        }
// ......................................................
// ..................RTCMultiConnection Code.............
// ......................................................

var connection = new RTCMultiConnection();

// by default, socket.io server is assumed to be deployed on your own URL
connection.socketURL = '/';

// comment-out below line if you do not have your own socket.io server
// connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

connection.socketMessageEvent = 'audio-conference-demo';

connection.session = {
    data: true,
    audio: true,
    video: false
};

connection.mediaConstraints = {
    audio: true,
    video: false
};

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: false
};

// https://www.rtcmulticonnection.org/docs/iceServers/
// use your own TURN-server here!
connection.iceServers = [{
    'urls': [
        'stun:stun.l.google.com:19302',
        'stun:stun1.l.google.com:19302',
        'stun:stun2.l.google.com:19302',
        'stun:stun.l.google.com:19302?transport=udp',
    ]
}];
connection.onmessage = appendDIV;

// 渲染左侧参会人员
connection.onPeerStateChanged = function() {
    getParticipantList();
}

// connection.setRoomOccupantListener(convertListToButtons);

// function convertListToButtons (roomName, occupants, isPrimary) {
//     var otherClientDiv = document.getElementById('otherClients');
//     var others = document.getElementById('others');
//     while (otherClientDiv.hasChildNodes()) {
//         otherClientDiv.removeChild(otherClientDiv.lastChild);
//     }
//     while (others.hasChildNodes()) {
//         others.removeChild(others.lastChild);
//     }

//     if (roomName === roomId) {
//         // 左侧参会人人员
//         for(var connection in occupants) {
//             var div = document.createElement('div');
//             var labelLeft = document.createTextNode(easyrtc.idToName(easyrtcid));
//             div.appendChild(labelLeft);
//             others.appendChild(div);
//         }
//     }

//     // 发送键
//     var sendButton = document.createElement('button');
//     sendButton.onclick = function(occupants) {
//         return function() {
//             var text = document.getElementById('sendMessageText').value;
//             addToConversation("Me", "message", text);
//             document.getElementById('sendMessageText').value = "";
//             if (roomId === roomName){
//                 for (var easyrtcid in occupants) {
//                     sendStuffWS(easyrtcid, text);
//                 }
//             }
//         };
//     }(occupants);

//     var sendLabel = document.createTextNode("发送 ");
//     sendButton.appendChild(sendLabel);
//     otherClientDiv.appendChild(sendButton);

//     if( !otherClientDiv.hasChildNodes() ) {
//         otherClientDiv.innerHTML = "<em>Nobody else logged in to talk to...</em>";
//     }
// }

// connection.audiosContainer = document.getElementById('others');
// connection.onstream = function(event) {
//     var width = parseInt(connection.audiosContainer.clientWidth / 2) - 20;
//     var mediaElement = getHTMLMediaElement(event.mediaElement, {
//         title: event.userid,
//         buttons: ['full-screen'],
//         width: width,
//         showOnMouseEnter: false
//     });

//     connection.audiosContainer.appendChild(mediaElement);

//     setTimeout(function() {
//         mediaElement.media.play();
//     }, 5000);

//     mediaElement.id = event.streamid;
// };

// connection.onstreamended = function(event) {
//     var mediaElement = document.getElementById(event.streamid);
//     if (mediaElement) {
//         mediaElement.parentNode.removeChild(mediaElement);
//     }
// };
    </script>
</html>
